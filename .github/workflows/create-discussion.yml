name: Create Release Discussion
run-name: üí¨ ICAP Release Discussion - ${{ github.ref_name }}

on:
  push:
    tags:
      - 'v*'

jobs:
  create-discussion:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Discussion from Release Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          REPO="${GITHUB_REPOSITORY}"
          OWNER="${REPO%/*}"
          REPO_NAME="${REPO#*/}"
          
          echo "Creating discussion for ICAP release: $VERSION"
          
          # Hole Repository ID
          REPO_ID=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { repository(owner: \\\"$OWNER\\\", name: \\\"$REPO_NAME\\\") { id } }\"}" \
            | jq -r '.data.repository.id')
          
          echo "Repository ID: $REPO_ID"
          
          if [ "$REPO_ID" = "null" ] || [ -z "$REPO_ID" ]; then
            echo "‚ùå Could not get repository ID"
            exit 1
          fi
          
          # Hole erste Discussion Category ID  
          CAT_ID=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { repository(owner: \\\"$OWNER\\\", name: \\\"$REPO_NAME\\\") { discussionCategories(first: 1) { edges { node { id } } } } }\"}" \
            | jq -r '.data.repository.discussionCategories.edges[0].node.id // empty')
          
          echo "Category ID: ${CAT_ID:-(none)}"
          
          # Erstelle Discussion mit einfachem Body f√ºr ICAP
          BODY="üöÄ ICAP Security Testing Suite Release $VERSION

Die neue Version ist jetzt verf√ºgbar!

Installation:
git clone https://github.com/$REPO.git
cd icap-test-script
git checkout $VERSION
docker compose up -d

Release Notes: https://github.com/$REPO/releases/tag/$VERSION

Nutzen Sie diesen Thread um Fragen zu stellen, Feedback zu geben oder Probleme zu berichten."
          
          # Escapen des Body f√ºr JSON
          BODY_JSON=$(echo "$BODY" | jq -Rs .)
          
          if [ ! -z "$CAT_ID" ]; then
            QUERY="{\"query\": \"mutation { createDiscussion(input: {repositoryId: \\\"$REPO_ID\\\", categoryId: \\\"$CAT_ID\\\", title: \\\"Release $VERSION - ICAP Security Testing Suite\\\", body: $BODY_JSON}) { discussion { id url } } }\"}"
          else
            QUERY="{\"query\": \"mutation { createDiscussion(input: {repositoryId: \\\"$REPO_ID\\\", title: \\\"Release $VERSION - ICAP Security Testing Suite\\\", body: $BODY_JSON}) { discussion { id url } } }\"}"
          fi
          
          echo "Executing mutation..."
          RESPONSE=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$QUERY")
          
          echo "Response: $RESPONSE"
          
          # Pr√ºfe auf Erfolg
          if echo "$RESPONSE" | jq -e '.data.createDiscussion.discussion.id' > /dev/null 2>&1; then
            echo "‚úÖ ICAP Release Discussion erstellt!"
            URL=$(echo "$RESPONSE" | jq -r '.data.createDiscussion.discussion.url')
            echo "URL: $URL"
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].message // "Unknown error"' 2>/dev/null || echo "JSON error")
            echo "‚ö†Ô∏è Discussion konnte nicht erstellt werden: $ERROR"
          fi
