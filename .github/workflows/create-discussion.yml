---
name: Create Release Discussion
run-name: üí¨ Release Discussion - ${{ github.ref_name }}

on:
  push:
    tags:
      - 'v*'

jobs:
  create-discussion:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Discussion from Release Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          REPO="${GITHUB_REPOSITORY}"
          OWNER="${REPO%/*}"
          REPO_NAME="${REPO#*/}"

          echo "Creating discussion for ICAP: $VERSION"

          # Hole Repository ID
          REPO_ID=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { repository(owner: \\\"$OWNER\\\", name: \\\"$REPO_NAME\\\") { id } }\"}" \
            | jq -r '.data.repository.id')

          echo "Repository ID: $REPO_ID"

          if [ "$REPO_ID" = "null" ] || [ -z "$REPO_ID" ]; then
            echo "‚ùå Could not get repository ID"
            exit 1
          fi

          # Hole erste Discussion Category ID
          CAT_ID=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { repository(owner: \\\"$OWNER\\\", name: \\\"$REPO_NAME\\\") { discussionCategories(first: 1) { edges { node { id } } } } }\"}" \
            | jq -r '.data.repository.discussionCategories.edges[0].node.id // empty')

          echo "Category ID: ${CAT_ID:-(none)}"

          # Erstelle Discussion mit ICAP Release Info
          BODY_TEXT="üöÄ ICAP Security Testing Suite Release $VERSION\n\nRelease Notes: https://github.com/$REPO/releases/tag/$VERSION"

          if [ ! -z "$CAT_ID" ]; then
            QUERY="mutation { createDiscussion(input: {repositoryId: \\\"$REPO_ID\\\", categoryId: \\\"$CAT_ID\\\", title: \\\"Release $VERSION - ICAP Suite\\\", body: \\\"$BODY_TEXT\\\"}) { discussion { id url } } }"
          else
            QUERY="mutation { createDiscussion(input: {repositoryId: \\\"$REPO_ID\\\", title: \\\"Release $VERSION - ICAP Suite\\\", body: \\\"$BODY_TEXT\\\"}) { discussion { id url } } }"
          fi

          echo "Executing mutation..."
          RESPONSE=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"$QUERY\"}")

          echo "Response: $RESPONSE"

          # Pr√ºfe auf Erfolg
          if echo "$RESPONSE" | jq -e '.data.createDiscussion.discussion.id' > /dev/null 2>&1; then
            echo "‚úÖ Discussion erstellt!"
            URL=$(echo "$RESPONSE" | jq -r '.data.createDiscussion.discussion.url')
            echo "URL: $URL"
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].message // "Unknown error"' 2>/dev/null || echo "JSON error")
            echo "‚ö†Ô∏è Discussion konnte nicht erstellt werden: $ERROR"
          fi
