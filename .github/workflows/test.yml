name: Tests
run-name: ðŸ§ª Tests - ${{ github.event_name }}

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'icap_*.py'
      - 'docker-compose.yml'
      - 'docker/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'icap_*.py'
      - 'docker-compose.yml'
      - 'docker/**'

jobs:
  syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        run: |
          python -m py_compile icap_test.py icap_server.py
          echo "âœ“ Python syntax is valid"

      - name: Check imports
        run: |
          python -m py_compile icap_test.py
          python -m py_compile icap_server.py
          echo "âœ“ All imports are valid"

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ICAP Server image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/icap-server
          push: false
          tags: icap-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check file sizes
        run: |
          SIZE_TEST=$(wc -l < icap_test.py)
          SIZE_SERVER=$(wc -l < icap_server.py)
          echo "icap_test.py: $SIZE_TEST lines"
          echo "icap_server.py: $SIZE_SERVER lines"
          echo "âœ“ File sizes reasonable"

      - name: Verify version consistency
        run: |
          TEST_VER=$(grep "__version__" icap_test.py | head -1 | grep -oP '\K[0-9]+\.[0-9]+\.[0-9]+')
          SERVER_VER=$(grep "__version__" icap_server.py | head -1 | grep -oP '\K[0-9]+\.[0-9]+\.[0-9]+')
          FILE_VER=$(cat VERSION)
          if [ "$TEST_VER" != "$SERVER_VER" ] || [ "$TEST_VER" != "$FILE_VER" ]; then
            echo "âŒ Version mismatch: TEST=$TEST_VER, SERVER=$SERVER_VER, FILE=$FILE_VER"
            exit 1
          fi
          echo "âœ“ Versions are consistent: $TEST_VER"

  lint-check:
    name: Linting & Style Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install pylint flake8

      - name: Run flake8 checks
        continue-on-error: true
        run: |
          flake8 icap_test.py icap_server.py --max-line-length=120 --count --show-source
          echo "âœ“ Flake8 check complete"

      - name: Run pylint checks
        continue-on-error: true
        run: |
          pylint icap_test.py icap_server.py --disable=C0111 --max-line-length=120
          echo "âœ“ Pylint check complete"
